name: Prepare BWS app credentials
description: "Load BWS secrets, prepare app credentials, select org, and mint a GitHub App token."
inputs:
  secrets:
    description: "Newline-delimited list of BWS secret names to export"
    required: true
  org_keys:
    description: "Newline-delimited list of org secret keys to map to the matrix org"
    required: true
  github_org:
    description: "GitHub org name for the current matrix entry"
    required: true
  repo:
    description: "Optional single repo name to scope the GitHub App token"
    required: false
    default: ""
  app_id_key:
    description: "Secret name for the GitHub App ID"
    required: false
    default: "GH_ORG_SHARED_APP_ID"
  app_pem_key:
    description: "Secret name for the GitHub App PEM"
    required: false
    default: "GH_ORG_SHARED_APP_PEM"
  chmod_keys:
    description: "Newline-delimited list of secret names to chmod 600"
    required: false
    default: ""
  orchestrator_keys:
    description: "Newline-delimited list of secret keys to export for orchestrator"
    required: false
    default: ""
  gitlab_mirror_keys:
    description: "Newline-delimited list of secret keys to export for GitLab mirror"
    required: false
    default: ""
  gitlab_protect_keys:
    description: "Newline-delimited list of secret keys to export for GitLab protection"
    required: false
    default: ""
outputs:
  github_app_token_file:
    description: "Path to the minted GitHub App token file"
    value: ${{ steps.store-token.outputs.github_app_token_file }}
  bws_env_orchestrator:
    description: "Path to the environment file for orchestrator usage"
    value: ${{ steps.scope-orchestrator.outputs.bws_env_orchestrator }}
  bws_env_gitlab_mirror:
    description: "Path to the environment file for GitLab mirror usage"
    value: ${{ steps.scope-gitlab.outputs.bws_env_gitlab_mirror }}
  bws_env_gitlab_protect:
    description: "Path to the environment file for GitLab protection usage"
    value: ${{ steps.scope-protect.outputs.bws_env_gitlab_protect }}
runs:
  using: composite
  steps:
    - name: Load BWS secrets to temp files
      shell: bash
      env:
        BWS_ACCESS_TOKEN: ${{ env.BWS_ACCESS_TOKEN }}
        BWS_PROJECT_ID: ${{ env.BWS_PROJECT_ID }}
      run: |
        set -euo pipefail
        if [ -z "${BWS_ACCESS_TOKEN:-}" ] || [ -z "${BWS_PROJECT_ID:-}" ]; then
          printf '%s\n' "BWS_ACCESS_TOKEN and BWS_PROJECT_ID must be set" >&2
          exit 1
        fi
        secrets_dir="${RUNNER_TEMP}/bws"
        mkdir -p "$secrets_dir"
        secrets=()
        while IFS= read -r key; do
          [ -z "$key" ] && continue
          secrets+=("$key")
        done <<'EOF'
        ${{ inputs.secrets }}
        EOF
        if [ "${#secrets[@]}" -eq 0 ]; then
          printf '%s\n' "No secrets provided" >&2
          exit 1
        fi
        bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
          env SECRETS_DIR="${secrets_dir}" \
          env BWS_NO_MASK_KEYS="${BWS_NO_MASK_KEYS:-}" \
          /bin/sh .github/scripts/bws_export_secret_files.sh \
            "${secrets_dir}" \
            "${secrets[@]}"

    - name: Prepare app credentials
      shell: bash
      run: |
        set -euo pipefail
        app_pem_key="${{ inputs.app_pem_key }}"
        app_id_key="${{ inputs.app_id_key }}"
        secrets_dir="${RUNNER_TEMP}/bws"
        src="${secrets_dir}/${app_pem_key}"
        dst="${secrets_dir}/${app_pem_key}.pem"
        umask 077
        if grep -q '\\n' "$src"; then
          data="$(cat "$src")"
          printf '%b' "$data" > "$dst"
        else
          cp "$src" "$dst"
        fi
        chmod 600 "$dst"
        while IFS= read -r key; do
          [ -z "$key" ] && continue
          chmod 600 "${secrets_dir}/${key}"
        done <<'EOF'
        ${{ inputs.chmod_keys }}
        EOF

    - name: Select org file path
      shell: bash
      run: |
        set -euo pipefail
        matrix_org="${{ inputs.github_org }}"
        secrets_dir="${RUNNER_TEMP}/bws"
        selected=""
        keys=()
        while IFS= read -r key; do
          [ -z "$key" ] && continue
          keys+=("$key")
        done <<'EOF'
        ${{ inputs.org_keys }}
        EOF
        if [ "${#keys[@]}" -eq 0 ]; then
          printf '%s\n' "No org keys provided; skipping org mapping check."
          exit 0
        fi
        for key in "${keys[@]}"; do
          org_value="$(cat "${secrets_dir}/${key}")"
          if [ "$matrix_org" = "$org_value" ]; then
            selected="$key"
            break
          fi
        done
        if [ -z "$selected" ]; then
          printf '%s\n' "Unknown org mapping for ${matrix_org}" >&2
          exit 1
        fi

    - name: Mint GitHub App token (JWT)
      id: app-token
      shell: bash
      run: |
        set -euo pipefail
        app_id_file="${RUNNER_TEMP}/bws/${{ inputs.app_id_key }}"
        pem_file="${RUNNER_TEMP}/bws/${{ inputs.app_pem_key }}.pem"
        output_file="${RUNNER_TEMP}/bws/GITHUB_APP_TOKEN"
        repo="${{ inputs.repo }}"
        python3 .github/scripts/github_app_token.py \
          --app-id-file "${app_id_file}" \
          --pem-file "${pem_file}" \
          --org "${{ inputs.github_org }}" \
          --repo "${repo}" \
          --output-file "${output_file}" \
          --policy-allowed-env "BWS_ACCESS_TOKEN,BWS_PROJECT_ID,BWS_NO_MASK_KEYS,GITHUB_ACTIONS,GITHUB_ENV,GITHUB_OUTPUT,GITHUB_RUN_ID,GITHUB_RUN_NUMBER,GITHUB_RUN_ATTEMPT,GITHUB_WORKFLOW,GITHUB_JOB,GITHUB_REF,GITHUB_REF_NAME,GITHUB_SHA,GITHUB_REPOSITORY,GITHUB_SERVER_URL,GITHUB_API_URL,RUNNER_TEMP,RUNNER_OS,RUNNER_ARCH,PATH,HOME,LANG,LC_ALL,LC_CTYPE,PYTHONPATH,pythonLocation,Python_ROOT_DIR,Python2_ROOT_DIR,Python3_ROOT_DIR,PKG_CONFIG_PATH,LD_LIBRARY_PATH,INPUT_REPO"
        if [ -n "${GITHUB_ACTIONS:-}" ]; then
          printf '%s\n' "::add-mask::$(cat "${output_file}")"
        fi

    - name: Store app token
      id: store-token
      shell: bash
      run: |
        set -euo pipefail
        token_file="${RUNNER_TEMP}/bws/GITHUB_APP_TOKEN"
        printf '%s\n' "github_app_token_file=${token_file}" >> "$GITHUB_OUTPUT"

    - name: Scope exports for orchestrator
      id: scope-orchestrator
      shell: bash
      run: |
        set -euo pipefail
        secrets_dir="${RUNNER_TEMP}/bws"
        exports_file="${secrets_dir}/exports-orchestrator.env"
        : > "${exports_file}"
        keys=()
        while IFS= read -r key; do
          [ -z "$key" ] && continue
          keys+=("$key")
        done <<'EOF'
        ${{ inputs.orchestrator_keys }}
        EOF
        for key in "${keys[@]}"; do
          if [ -f "${secrets_dir}/${key}" ]; then
            printf '%s\n' "${key}_FILE=${secrets_dir}/${key}" >> "${exports_file}"
          fi
        done
        chmod 600 "${exports_file}"
        printf '%s\n' "bws_env_orchestrator=${exports_file}" >> "$GITHUB_OUTPUT"

    - name: Scope exports for GitLab mirror
      id: scope-gitlab
      shell: bash
      run: |
        set -euo pipefail
        secrets_dir="${RUNNER_TEMP}/bws"
        exports_file="${secrets_dir}/exports-gitlab.env"
        : > "${exports_file}"
        keys=()
        while IFS= read -r key; do
          [ -z "$key" ] && continue
          keys+=("$key")
        done <<'EOF'
        ${{ inputs.gitlab_mirror_keys }}
        EOF
        for key in "${keys[@]}"; do
          if [ -f "${secrets_dir}/${key}" ]; then
            printf '%s\n' "${key}_FILE=${secrets_dir}/${key}" >> "${exports_file}"
          fi
        done
        chmod 600 "${exports_file}"
        printf '%s\n' "bws_env_gitlab_mirror=${exports_file}" >> "$GITHUB_OUTPUT"

    - name: Scope exports for GitLab protections
      id: scope-protect
      shell: bash
      run: |
        set -euo pipefail
        secrets_dir="${RUNNER_TEMP}/bws"
        exports_file="${secrets_dir}/exports-protect.env"
        : > "${exports_file}"
        keys=()
        while IFS= read -r key; do
          [ -z "$key" ] && continue
          keys+=("$key")
        done <<'EOF'
        ${{ inputs.gitlab_protect_keys }}
        EOF
        for key in "${keys[@]}"; do
          if [ -f "${secrets_dir}/${key}" ]; then
            printf '%s\n' "${key}_FILE=${secrets_dir}/${key}" >> "${exports_file}"
          fi
        done
        chmod 600 "${exports_file}"
        printf '%s\n' "bws_env_gitlab_protect=${exports_file}" >> "$GITHUB_OUTPUT"
