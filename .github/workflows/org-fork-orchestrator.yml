name: Org Fork Orchestrator

on:
  schedule:
    - cron: "17 3 * * *"
    - cron: "17 23 * * *"
  workflow_dispatch:
    inputs:
      repo:
        description: "Optional single fork repo name to target"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: org-fork-orchestrator-${{ github.workflow }}-${{ github.ref }}-${{ inputs.repo || 'all' }}
  cancel-in-progress: true

jobs:
  matrix:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Sanity check (compileall)
        shell: bash
        run: |
          set -euo pipefail
          python3 -m compileall .github/scripts

      - name: Shellcheck scripts
        shell: bash
        run: |
          set -euo pipefail
          shellcheck .github/scripts/*.sh

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Load BWS config and build matrix
        id: build-matrix
        shell: bash
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_GH_FORKS_TOKEN || secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_FORKS_ORCHESTRATOR_PROJ_ID || secrets.BWS_FORKS_ORCHESTRATOR_PROJ_ID }}
          BWS_NO_MASK_KEYS: GH_ORG_TOOLS,GH_ORG_SECOPS,GH_ORG_WIKI,GH_ORG_DIVERGE
        run: |
          set -euo pipefail
          umask 077
          if [ -z "${BWS_ACCESS_TOKEN:-}" ]; then
            printf '%s\n' "Missing BWS access token. Set secrets.BWS_GH_FORKS_TOKEN." >&2
            exit 1
          fi
          if [ -z "${BWS_PROJECT_ID:-}" ]; then
            printf '%s\n' "Missing BWS project ID. Set vars.BWS_FORKS_ORCHESTRATOR_PROJ_ID (or secrets.BWS_FORKS_ORCHESTRATOR_PROJ_ID)." >&2
            exit 1
          fi
          bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
            env PATH="${PATH}" \
            env BWS_NO_MASK_KEYS="${BWS_NO_MASK_KEYS:-}" \
            /bin/sh .github/scripts/bws_export_secret_files.sh "${RUNNER_TEMP}/bws" \
              GH_ORG_TOOLS \
              GH_ORG_SECOPS \
              GH_ORG_WIKI \
              GH_ORG_DIVERGE
          for key in GH_ORG_TOOLS GH_ORG_SECOPS GH_ORG_WIKI GH_ORG_DIVERGE; do
            file_path="${RUNNER_TEMP}/bws/${key}"
            export "${key}_FILE=${file_path}"
          done
          /bin/sh .github/scripts/build_org_matrix.sh

  orchestrate:
    needs: matrix
    name: Orchestrate (${{ matrix.github_org }})
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix.outputs.matrix) }}
      max-parallel: 1
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      issues: write
    concurrency:
      group: org-fork-orchestrator-${{ github.workflow }}-${{ matrix.github_org }}
      cancel-in-progress: true
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Prepare BWS app credentials
        id: bws
        uses: ./.github/actions/prepare-bws-app
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_GH_FORKS_TOKEN || secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_FORKS_ORCHESTRATOR_PROJ_ID || secrets.BWS_FORKS_ORCHESTRATOR_PROJ_ID }}
        with:
          secrets: |
            GH_ORG_SHARED_APP_ID
            GH_ORG_TOOLS
            GH_ORG_SECOPS
            GH_ORG_WIKI
            GH_ORG_DIVERGE
            GH_BRANCH_PREFIX
            GH_BRANCH_PRODUCT
            GH_BRANCH_STAGING
            GH_BRANCH_SNAPSHOT
            GH_BRANCH_FEATURE
            GH_BRANCH_RELEASE
            GH_ORG_SHARED_APP_PEM
          scoped_keys: |
            GH_BRANCH_PREFIX
            GH_BRANCH_PRODUCT
            GH_BRANCH_STAGING
            GH_BRANCH_SNAPSHOT
            GH_BRANCH_FEATURE
            GH_BRANCH_RELEASE
            GITHUB_APP_TOKEN
          org_keys: |
            GH_ORG_TOOLS
            GH_ORG_SECOPS
            GH_ORG_WIKI
            GH_ORG_DIVERGE
          github_org: ${{ matrix.github_org }}
          repo: ${{ inputs.repo }}
          app_id_key: GH_ORG_SHARED_APP_ID
          app_pem_key: GH_ORG_SHARED_APP_PEM

      - name: Validate INPUT_REPO
        shell: bash
        env:
          INPUT_REPO: ${{ inputs.repo }}
        run: |
          set -euo pipefail
          /bin/sh .github/scripts/validate_input_repo.sh

      - name: Run orchestrator
        env:
          INPUT_REPO: ${{ inputs.repo }}
        run: |
          set -euo pipefail
          set -a
          . "${{ steps.bws.outputs.bws_env_file }}"
          set +a
          python3 .github/scripts/orchestrator.py

      - name: Post cleanup
        if: always()
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          rm -f "${RUNNER_TEMP}/bws/GH_ORG_SHARED_APP_PEM.pem" \
                "${RUNNER_TEMP}/bws/GITHUB_APP_TOKEN"
          rm -rf "${RUNNER_TEMP}/bws"
