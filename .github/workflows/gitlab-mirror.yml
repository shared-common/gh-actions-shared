name: GitLab Mirror

on:
  schedule:
    - cron: "47 3 * * *"
    - cron: "47 23 * * *"
  workflow_dispatch:
    inputs:
      repo:
        description: "Optional single fork repo name to target"
        required: false
        type: string
      clear_cache:
        description: "Clear repo discovery cache before running"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: gitlab-mirror-${{ github.workflow }}-${{ github.ref }}-${{ inputs.repo || 'all' }}
  cancel-in-progress: true

jobs:
  matrix:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Sanity check (compileall)
        shell: bash
        run: |
          set -euo pipefail
          python3 -m compileall .github/scripts

      - name: Shellcheck scripts
        shell: bash
        run: |
          set -euo pipefail
          shellcheck .github/scripts/*.sh

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Load BWS config and build matrix
        id: build-matrix
        shell: bash
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_PROJECT_ID }}
        run: |
          set -euo pipefail
          bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
            env PATH="${PATH}" \
            /bin/sh -c 'sh .github/scripts/bws_export_env_unmasked.sh \
              GH_ORG_TBOX \
              GH_ORG_SECOPS \
              GH_ORG_WIKI \
              GH_ORG_DIVERGE \
              GL_GROUP_ZFORKS \
              GL_GROUP_TBOX \
              GL_GROUP_SECOPS \
              GL_GROUP_WIKI \
              GL_GROUP_ZDIVERGE \
              GL_GROUP_GENERAL \
              ; .github/scripts/build_gitlab_matrix.sh' | sed -e 's/^/matrix=/' >> "$GITHUB_OUTPUT"

  mirror:
    needs: matrix
    name: Mirror (${{ matrix.github_org }})
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix.outputs.matrix) }}
      max-parallel: 1
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      issues: write
    outputs:
      gitlab_created: ${{ steps.gitlab-mirror.outputs.gitlab_created }}
    concurrency:
      group: gitlab-mirror-${{ github.workflow }}-${{ matrix.github_org }}
      cancel-in-progress: true
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Ensure cache directories
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/.cache"
          if [ ! -f "${GITHUB_WORKSPACE}/.cache/repo-discovery.json" ]; then
            printf '[]' > "${GITHUB_WORKSPACE}/.cache/repo-discovery.json"
          fi
          if [ ! -f "${GITHUB_WORKSPACE}/.cache/repo-metadata.json" ]; then
            printf '{}' > "${GITHUB_WORKSPACE}/.cache/repo-metadata.json"
          fi

      - name: Cache repo discovery
        id: repo-cache
        if: ${{ !inputs.clear_cache }}
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ github.workspace }}/.cache/repo-discovery.json
            ${{ github.workspace }}/.cache/repo-metadata.json
          key: >-
            gitlab-mirror-discovery-${{ github.repository }}-${{ github.run_id }}
          restore-keys: |
            gitlab-mirror-discovery-${{ github.repository }}-

      - name: Clear repo discovery cache
        if: ${{ inputs.clear_cache }}
        shell: bash
        run: |
          set -euo pipefail
          rm -f "${GITHUB_WORKSPACE}/.cache/repo-discovery.json"

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Load BWS secrets to temp files
        shell: bash
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_PROJECT_ID }}
        run: |
          set -euo pipefail
          secrets_dir="${RUNNER_TEMP}/bws"
          mkdir -p "$secrets_dir"
          bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
            env SECRETS_DIR="${secrets_dir}" \
            /bin/sh .github/scripts/bws_export_secret_files.sh \
              "${secrets_dir}" \
              GH_ORG_SHARED_APP_ID \
              GH_ORG_TBOX \
              GH_ORG_SECOPS \
              GH_ORG_WIKI \
              GH_ORG_DIVERGE \
              GH_BRANCH_PREFIX \
              GH_BRANCH_PRODUCT \
              GH_BRANCH_STAGING \
              GH_BRANCH_FEATURE \
              GH_BRANCH_RELEASE \
              GL_GROUP_ZFORKS \
              GL_GROUP_TBOX \
              GL_GROUP_SECOPS \
              GL_GROUP_WIKI \
              GL_GROUP_ZDIVERGE \
              GL_GROUP_GENERAL \
              GH_ORG_SHARED_PEM \
              GL_TOKEN_MCZFORKS

      - name: Expose secret file paths
        shell: bash
        run: |
          set -euo pipefail
          secrets_dir="${RUNNER_TEMP}/bws"
          for key in \
            GH_ORG_SHARED_APP_ID \
            GH_ORG_TBOX \
            GH_ORG_SECOPS \
            GH_ORG_WIKI \
            GH_ORG_DIVERGE \
            GH_BRANCH_PREFIX \
            GH_BRANCH_PRODUCT \
            GH_BRANCH_STAGING \
            GH_BRANCH_FEATURE \
            GH_BRANCH_RELEASE \
            GL_GROUP_ZFORKS \
            GL_GROUP_TBOX \
            GL_GROUP_SECOPS \
            GL_GROUP_WIKI \
            GL_GROUP_ZDIVERGE \
            GL_GROUP_GENERAL \
            GH_ORG_SHARED_PEM \
            GL_TOKEN_MCZFORKS
          do
            echo "${key}_FILE=${secrets_dir}/${key}" >> "$GITHUB_ENV"
          done

      - name: Prepare app credentials
        shell: bash
        run: |
          set -euo pipefail
          umask 077
          src="${RUNNER_TEMP}/bws/GH_ORG_SHARED_PEM"
          dst="${RUNNER_TEMP}/bws/GH_ORG_SHARED_PEM.pem"
          data="$(cat "$src")"
          if printf '%s' "$data" | grep -q '\\n'; then
            printf '%b' "$data" > "$dst"
          else
            printf '%s' "$data" > "$dst"
          fi
          chmod 600 "$dst"
          chmod 600 "${RUNNER_TEMP}/bws/GL_TOKEN_MCZFORKS"
          echo "GH_ORG_SHARED_PEM_FILE=${dst}" >> "$GITHUB_ENV"
          echo \
            "GL_TOKEN_MCZFORKS_FILE=${RUNNER_TEMP}/bws/GL_TOKEN_MCZFORKS" \
            >> "$GITHUB_ENV"

      - name: Read app key
        id: app-key
        shell: bash
        run: |
          set -euo pipefail
          pem="$(cat "${RUNNER_TEMP}/bws/GH_ORG_SHARED_PEM.pem")"
          printf '%s\n' "$pem" | while IFS= read -r line; do
            if [ -n "$line" ]; then
              printf '::add-mask::%s\n' "$line"
            fi
          done
          {
            echo "private_key<<EOF"
            printf '%s\n' "$pem"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Read app context
        id: app-context
        shell: bash
        run: |
          set -euo pipefail
          app_id="$(cat "${RUNNER_TEMP}/bws/GH_ORG_SHARED_APP_ID")"
          echo "app_id=${app_id}" >> "$GITHUB_OUTPUT"
          echo "org=${{ matrix.github_org }}" >> "$GITHUB_OUTPUT"

      - name: Mint GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ steps.app-context.outputs.app_id }}
          private-key: ${{ steps.app-key.outputs.private_key }}
          owner: ${{ steps.app-context.outputs.org }}
          repositories: ${{ inputs.repo }}

      - name: Store app token
        shell: bash
        run: |
          set -euo pipefail
          umask 077
          token_file="${RUNNER_TEMP}/bws/GITHUB_APP_TOKEN"
          printf '%s' "${{ steps.app-token.outputs.token }}" > "$token_file"
          echo "GITHUB_APP_TOKEN_FILE=${token_file}" >> "$GITHUB_ENV"

      - name: Validate INPUT_REPO
        shell: bash
        env:
          INPUT_REPO: ${{ inputs.repo }}
        run: |
          set -euo pipefail
          /bin/sh .github/scripts/validate_input_repo.sh

      - name: Run GitLab mirror
        id: gitlab-mirror
        env:
          INPUT_REPO: ${{ inputs.repo }}
          REPO_CACHE_PATH: ${{ github.workspace }}/.cache/repo-discovery.json
          REPO_META_CACHE_PATH: ${{ github.workspace }}/.cache/repo-metadata.json
          REPO_CACHE_TTL_DISCOVERY: >-
            ${{ inputs.clear_cache && '0' || vars.REPO_CACHE_TTL_DISCOVERY ||
            '3600' }}
          REPO_CACHE_TTL_META: ${{ vars.REPO_CACHE_TTL_META || '800' }}
          REPO_CACHE_TTL_NEGATIVE: ${{ vars.REPO_CACHE_TTL_NEGATIVE || '1800' }}
          REPO_CACHE_TTL_GITLAB_PROJ: ${{ vars.REPO_CACHE_TTL_GITLAB_PROJ || '21600' }}
          REPO_CACHE_TTL_GITLAB_BRANCH: ${{ vars.REPO_CACHE_TTL_GITLAB_BRANCH || '900' }}
          GH_ORG_SHARED_PEM_FILE: ${{ runner.temp }}/bws/GH_ORG_SHARED_PEM.pem
          GH_ORG_SHARED_APP_ID_FILE: ${{ runner.temp }}/bws/GH_ORG_SHARED_APP_ID
          GH_BRANCH_PREFIX_FILE: ${{ runner.temp }}/bws/GH_BRANCH_PREFIX
          GH_BRANCH_PRODUCT_FILE: ${{ runner.temp }}/bws/GH_BRANCH_PRODUCT
          GH_BRANCH_STAGING_FILE: ${{ runner.temp }}/bws/GH_BRANCH_STAGING
          GH_BRANCH_FEATURE_FILE: ${{ runner.temp }}/bws/GH_BRANCH_FEATURE
          GH_BRANCH_RELEASE_FILE: ${{ runner.temp }}/bws/GH_BRANCH_RELEASE
          GH_ORG_TBOX_FILE: ${{ runner.temp }}/bws/GH_ORG_TBOX
          GH_ORG_SECOPS_FILE: ${{ runner.temp }}/bws/GH_ORG_SECOPS
          GH_ORG_WIKI_FILE: ${{ runner.temp }}/bws/GH_ORG_WIKI
          GH_ORG_DIVERGE_FILE: ${{ runner.temp }}/bws/GH_ORG_DIVERGE
          GL_GROUP_ZFORKS_FILE: ${{ runner.temp }}/bws/GL_GROUP_ZFORKS
          GL_GROUP_TBOX_FILE: ${{ runner.temp }}/bws/GL_GROUP_TBOX
          GL_GROUP_SECOPS_FILE: ${{ runner.temp }}/bws/GL_GROUP_SECOPS
          GL_GROUP_WIKI_FILE: ${{ runner.temp }}/bws/GL_GROUP_WIKI
          GL_GROUP_ZDIVERGE_FILE: ${{ runner.temp }}/bws/GL_GROUP_ZDIVERGE
          GL_GROUP_GENERAL_FILE: ${{ runner.temp }}/bws/GL_GROUP_GENERAL
          GITHUB_APP_TOKEN_FILE: ${{ runner.temp }}/bws/GITHUB_APP_TOKEN
          GL_TOKEN_MCZFORKS_FILE: ${{ runner.temp }}/bws/GL_TOKEN_MCZFORKS
        run: |
          python3 .github/scripts/gitlab_mirror.py

      - name: Apply protections
        if: steps.gitlab-mirror.outputs.gitlab_created == 'true'
        env:
          INPUT_REPO: ${{ inputs.repo }}
          REPO_CACHE_PATH: ${{ github.workspace }}/.cache/repo-discovery.json
          REPO_META_CACHE_PATH: ${{ github.workspace }}/.cache/repo-metadata.json
          REPO_CACHE_TTL_DISCOVERY: >-
            ${{ inputs.clear_cache && '0' || vars.REPO_CACHE_TTL_DISCOVERY ||
            '3600' }}
          REPO_CACHE_TTL_META: ${{ vars.REPO_CACHE_TTL_META || '800' }}
          REPO_CACHE_TTL_NEGATIVE: ${{ vars.REPO_CACHE_TTL_NEGATIVE || '1800' }}
          REPO_CACHE_TTL_GITLAB_PROJ: ${{ vars.REPO_CACHE_TTL_GITLAB_PROJ || '21600' }}
          REPO_CACHE_TTL_GITLAB_BRANCH: ${{ vars.REPO_CACHE_TTL_GITLAB_BRANCH || '900' }}
          GH_ORG_SHARED_APP_ID_FILE: ${{ runner.temp }}/bws/GH_ORG_SHARED_APP_ID
          GH_BRANCH_PREFIX_FILE: ${{ runner.temp }}/bws/GH_BRANCH_PREFIX
          GH_BRANCH_STAGING_FILE: ${{ runner.temp }}/bws/GH_BRANCH_STAGING
          GH_BRANCH_RELEASE_FILE: ${{ runner.temp }}/bws/GH_BRANCH_RELEASE
          GH_ORG_TBOX_FILE: ${{ runner.temp }}/bws/GH_ORG_TBOX
          GH_ORG_SECOPS_FILE: ${{ runner.temp }}/bws/GH_ORG_SECOPS
          GH_ORG_WIKI_FILE: ${{ runner.temp }}/bws/GH_ORG_WIKI
          GH_ORG_DIVERGE_FILE: ${{ runner.temp }}/bws/GH_ORG_DIVERGE
          GL_GROUP_ZFORKS_FILE: ${{ runner.temp }}/bws/GL_GROUP_ZFORKS
          GL_GROUP_TBOX_FILE: ${{ runner.temp }}/bws/GL_GROUP_TBOX
          GL_GROUP_SECOPS_FILE: ${{ runner.temp }}/bws/GL_GROUP_SECOPS
          GL_GROUP_WIKI_FILE: ${{ runner.temp }}/bws/GL_GROUP_WIKI
          GL_GROUP_ZDIVERGE_FILE: ${{ runner.temp }}/bws/GL_GROUP_ZDIVERGE
          GL_GROUP_GENERAL_FILE: ${{ runner.temp }}/bws/GL_GROUP_GENERAL
          GITHUB_APP_TOKEN_FILE: ${{ runner.temp }}/bws/GITHUB_APP_TOKEN
          GL_TOKEN_MCZFORKS_FILE: ${{ runner.temp }}/bws/GL_TOKEN_MCZFORKS
        run: |
          python3 .github/scripts/gitlab_branch_protection.py

      - name: Ensure repo cache files
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/.cache"
          if [ ! -f "${GITHUB_WORKSPACE}/.cache/repo-discovery.json" ]; then
            printf '[]' > "${GITHUB_WORKSPACE}/.cache/repo-discovery.json"
          fi

      - name: Save repo caches
        if: always()
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ github.workspace }}/.cache/repo-discovery.json
            ${{ github.workspace }}/.cache/repo-metadata.json
          key: >-
            gitlab-mirror-discovery-${{ github.repository }}-${{ github.run_id }}

      - name: Post cleanup
        if: always()
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          rm -f "${RUNNER_TEMP}/bws/GH_ORG_SHARED_PEM.pem" \
                "${RUNNER_TEMP}/bws/GL_TOKEN_MCZFORKS" \
                "${RUNNER_TEMP}/bws/GITHUB_APP_TOKEN"
          rm -rf "${RUNNER_TEMP}/bws"
          for key in \
            GH_ORG_SHARED_APP_ID_FILE \
            GH_ORG_TBOX_FILE \
            GH_ORG_SECOPS_FILE \
            GH_ORG_WIKI_FILE \
            GH_ORG_DIVERGE_FILE \
            GH_BRANCH_PREFIX_FILE \
            GH_BRANCH_PRODUCT_FILE \
            GH_BRANCH_STAGING_FILE \
            GH_BRANCH_FEATURE_FILE \
            GH_BRANCH_RELEASE_FILE \
            GL_GROUP_ZFORKS_FILE \
            GL_GROUP_TBOX_FILE \
            GL_GROUP_SECOPS_FILE \
            GL_GROUP_WIKI_FILE \
            GL_GROUP_ZDIVERGE_FILE \
            GL_GROUP_GENERAL_FILE \
            GH_ORG_SHARED_PEM_FILE \
            GL_TOKEN_MCZFORKS_FILE \
            GITHUB_APP_TOKEN_FILE
          do
            printf '%s<<EOF\nEOF\n' "$key" >> "$GITHUB_ENV"
          done
