name: GitLab Mirror

on:
  schedule:
    - cron: "47 3 * * *"
    - cron: "47 23 * * *"
  workflow_dispatch:
    inputs:
      repo:
        description: "Optional single fork repo name to target"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: gitlab-mirror-${{ github.workflow }}-${{ github.ref }}-${{ inputs.repo || 'all' }}
  cancel-in-progress: true

jobs:
  matrix:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Sanity check (compileall)
        shell: bash
        run: |
          set -euo pipefail
          python3 -m compileall .github/scripts

      - name: Shellcheck scripts
        shell: bash
        run: |
          set -euo pipefail
          shellcheck .github/scripts/*.sh

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Load BWS config and build matrix
        id: build-matrix
        shell: bash
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_PROJECT_ID }}
        run: |
          set -euo pipefail
          umask 077
          bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
            env PATH="${PATH}" \
            /bin/sh .github/scripts/bws_export_secret_files.sh "${RUNNER_TEMP}/bws" \
              GH_ORG_TOOLS \
              GH_ORG_SECOPS \
              GH_ORG_WIKI \
              GH_ORG_DIVERGE \
              GL_GROUP_TOP_DERIVED \
              GL_GROUP_SUB_TOOLS \
              GL_GROUP_SUB_SECOPS \
              GL_GROUP_SUB_WIKI \
              GL_GROUP_SUB_DIVERGE
          for key in GH_ORG_TOOLS GH_ORG_SECOPS GH_ORG_WIKI GH_ORG_DIVERGE \
            GL_GROUP_TOP_DERIVED GL_GROUP_SUB_TOOLS GL_GROUP_SUB_SECOPS GL_GROUP_SUB_WIKI GL_GROUP_SUB_DIVERGE
          do
            printf '%s\n' "${key}_FILE=${RUNNER_TEMP}/bws/${key}" >> "$GITHUB_ENV"
          done
          /bin/sh .github/scripts/build_gitlab_matrix.sh | sed -e 's/^/matrix=/' >> "$GITHUB_OUTPUT"

  mirror:
    needs: matrix
    name: Mirror (${{ matrix.github_org }})
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix.outputs.matrix) }}
      max-parallel: 1
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      gitlab_created: ${{ steps.gitlab-mirror.outputs.gitlab_created }}
    concurrency:
      group: gitlab-mirror-${{ github.workflow }}-${{ matrix.github_org }}
      cancel-in-progress: true
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Prepare BWS app credentials
        uses: ./.github/actions/prepare-bws-app
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_PROJECT_ID }}
        with:
          secrets: |
            GH_ORG_SHARED_APP_ID
            GH_ORG_TOOLS
            GH_ORG_SECOPS
            GH_ORG_WIKI
            GH_ORG_DIVERGE
            GH_BRANCH_PREFIX
            GH_BRANCH_PRODUCT
            GH_BRANCH_STAGING
            GH_BRANCH_FEATURE
            GH_BRANCH_RELEASE
            GL_GROUP_TOP_DERIVED
            GL_GROUP_SUB_TOOLS
            GL_GROUP_SUB_SECOPS
            GL_GROUP_SUB_WIKI
            GL_GROUP_SUB_DIVERGE
            GH_ORG_SHARED_PEM
            GL_TOKEN_DERIVED
          org_keys: |
            GH_ORG_TOOLS
            GH_ORG_SECOPS
            GH_ORG_WIKI
            GH_ORG_DIVERGE
          github_org: ${{ matrix.github_org }}
          repo: ${{ inputs.repo }}
          app_id_key: GH_ORG_SHARED_APP_ID
          app_pem_key: GH_ORG_SHARED_PEM
          chmod_keys: |
            GL_TOKEN_DERIVED

      - name: Validate INPUT_REPO
        shell: bash
        env:
          INPUT_REPO: ${{ inputs.repo }}
        run: |
          set -euo pipefail
          /bin/sh .github/scripts/validate_input_repo.sh

      - name: Run GitLab mirror
        id: gitlab-mirror
        env:
          INPUT_REPO: ${{ inputs.repo }}
          GH_ORG_SHARED_PEM_FILE: ${{ runner.temp }}/bws/GH_ORG_SHARED_PEM.pem
          GH_ORG_SHARED_APP_ID_FILE: ${{ runner.temp }}/bws/GH_ORG_SHARED_APP_ID
          GH_BRANCH_PREFIX_FILE: ${{ runner.temp }}/bws/GH_BRANCH_PREFIX
          GH_BRANCH_PRODUCT_FILE: ${{ runner.temp }}/bws/GH_BRANCH_PRODUCT
          GH_BRANCH_STAGING_FILE: ${{ runner.temp }}/bws/GH_BRANCH_STAGING
          GH_BRANCH_FEATURE_FILE: ${{ runner.temp }}/bws/GH_BRANCH_FEATURE
          GH_BRANCH_RELEASE_FILE: ${{ runner.temp }}/bws/GH_BRANCH_RELEASE
          GL_GROUP_TOP_DERIVED_FILE: ${{ runner.temp }}/bws/GL_GROUP_TOP_DERIVED
          GL_GROUP_SUB_TOOLS_FILE: ${{ runner.temp }}/bws/GL_GROUP_SUB_TOOLS
          GL_GROUP_SUB_SECOPS_FILE: ${{ runner.temp }}/bws/GL_GROUP_SUB_SECOPS
          GL_GROUP_SUB_WIKI_FILE: ${{ runner.temp }}/bws/GL_GROUP_SUB_WIKI
          GL_GROUP_SUB_DIVERGE_FILE: ${{ runner.temp }}/bws/GL_GROUP_SUB_DIVERGE
          GITHUB_APP_TOKEN_FILE: ${{ runner.temp }}/bws/GITHUB_APP_TOKEN
          GL_TOKEN_DERIVED_FILE: ${{ runner.temp }}/bws/GL_TOKEN_DERIVED
        run: |
          python3 .github/scripts/gitlab_mirror.py

      - name: Apply protections
        if: steps.gitlab-mirror.outputs.gitlab_created == 'true'
        env:
          INPUT_REPO: ${{ inputs.repo }}
          GH_ORG_SHARED_APP_ID_FILE: ${{ runner.temp }}/bws/GH_ORG_SHARED_APP_ID
          GH_BRANCH_PREFIX_FILE: ${{ runner.temp }}/bws/GH_BRANCH_PREFIX
          GH_BRANCH_STAGING_FILE: ${{ runner.temp }}/bws/GH_BRANCH_STAGING
          GH_BRANCH_RELEASE_FILE: ${{ runner.temp }}/bws/GH_BRANCH_RELEASE
          GL_GROUP_TOP_DERIVED_FILE: ${{ runner.temp }}/bws/GL_GROUP_TOP_DERIVED
          GL_GROUP_SUB_TOOLS_FILE: ${{ runner.temp }}/bws/GL_GROUP_SUB_TOOLS
          GL_GROUP_SUB_SECOPS_FILE: ${{ runner.temp }}/bws/GL_GROUP_SUB_SECOPS
          GL_GROUP_SUB_WIKI_FILE: ${{ runner.temp }}/bws/GL_GROUP_SUB_WIKI
          GL_GROUP_SUB_DIVERGE_FILE: ${{ runner.temp }}/bws/GL_GROUP_SUB_DIVERGE
          GITHUB_APP_TOKEN_FILE: ${{ runner.temp }}/bws/GITHUB_APP_TOKEN
          GL_TOKEN_DERIVED_FILE: ${{ runner.temp }}/bws/GL_TOKEN_DERIVED
        run: |
          python3 .github/scripts/gitlab_branch_protection.py

      - name: Post cleanup
        if: always()
        shell: /usr/bin/bash --noprofile --norc -e -o pipefail {0}
        run: |
          rm -f "${RUNNER_TEMP}/bws/GH_ORG_SHARED_PEM.pem" \
                "${RUNNER_TEMP}/bws/GL_TOKEN_DERIVED" \
                "${RUNNER_TEMP}/bws/GITHUB_APP_TOKEN"
          rm -rf "${RUNNER_TEMP}/bws"
          for key in \
            GH_ORG_SHARED_APP_ID_FILE \
            GH_ORG_TOOLS_FILE \
            GH_ORG_SECOPS_FILE \
            GH_ORG_WIKI_FILE \
            GH_ORG_DIVERGE_FILE \
            GH_BRANCH_PREFIX_FILE \
            GH_BRANCH_PRODUCT_FILE \
            GH_BRANCH_STAGING_FILE \
            GH_BRANCH_FEATURE_FILE \
            GH_BRANCH_RELEASE_FILE \
            GL_GROUP_TOP_DERIVED_FILE \
            GL_GROUP_SUB_TOOLS_FILE \
            GL_GROUP_SUB_SECOPS_FILE \
            GL_GROUP_SUB_WIKI_FILE \
            GL_GROUP_SUB_DIVERGE_FILE \
            GH_ORG_SHARED_PEM_FILE \
            GL_TOKEN_DERIVED_FILE \
            GITHUB_APP_TOKEN_FILE
          do
            printf '%s<<EOF\nEOF\n' "$key" >> "$GITHUB_ENV"
          done
          {
            printf '%s\n' "GH_APP_PRIVATE_KEY="
            printf '%s\n' "GH_APP_ID="
            printf '%s\n' "GH_APP_ORG="
          } >> "$GITHUB_ENV"
