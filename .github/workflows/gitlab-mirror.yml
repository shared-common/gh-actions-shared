name: GitLab Mirror

on:
  schedule:
    - cron: "47 3 * * *"
    - cron: "47 23 * * *"
  workflow_dispatch:
    inputs:
      repo:
        description: "Optional single fork repo name to target"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: gitlab-mirror-${{ github.ref }}-${{ inputs.repo || 'all' }}
  cancel-in-progress: false

jobs:
  matrix:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.build-matrix.outputs.matrix }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Load BWS config
        id: bws
        shell: bash
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_PROJECT_ID }}
        run: |
          bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
            env GITHUB_OUTPUT="${GITHUB_OUTPUT}" \
            /bin/sh .github/scripts/bws_export_output.sh \
              GH_ORG_SHARED_APP_ID \
              GH_BRANCH_PREFIX \
              GH_BRANCH_PRODUCT \
              GH_BRANCH_STAGING \
              GH_BRANCH_FEATURE \
              GH_BRANCH_RELEASE \
              GL_TOKEN_MCZFORKS \
              GH_ORG_TBOX \
              GH_ORG_SECOPS \
              GH_ORG_WIKI \
              GH_ORG_DIVERGE \
              GL_GROUP_ZFORKS \
              GL_GROUP_TBOX \
              GL_GROUP_SECOPS \
              GL_GROUP_WIKI \
              GL_GROUP_ZDIVERGE \
              GL_GROUP_GENERAL

      - name: Build matrix
        id: build-matrix
        shell: bash
        run: |
          python3 - <<'PY' >> "$GITHUB_OUTPUT"
          import json
          import os

          org_keys = ("GH_ORG_TBOX", "GH_ORG_SECOPS", "GH_ORG_WIKI", "GH_ORG_DIVERGE")
          group_keys = (
              "GL_GROUP_ZFORKS",
              "GL_GROUP_TBOX",
              "GL_GROUP_SECOPS",
              "GL_GROUP_WIKI",
              "GL_GROUP_ZDIVERGE",
              "GL_GROUP_GENERAL",
          )
          env = {key: os.environ.get(key, "").strip() for key in org_keys + group_keys}
          missing = [key for key, value in env.items() if not value]
          if missing:
            raise SystemExit(f"Missing config in env: {', '.join(missing)}")
          dupes = sorted({env[key] for key in org_keys if env[key] and list(env.values()).count(env[key]) > 1})
          if dupes:
            raise SystemExit(f"Duplicate org entries: {', '.join(dupes)}")
          matrix = {
              "include": [
                  {
                      "github_org": env["GH_ORG_TBOX"],
                      "gitlab_group": env["GL_GROUP_ZFORKS"],
                      "gitlab_subgroup": env["GL_GROUP_TBOX"],
                  },
                  {
                      "github_org": env["GH_ORG_SECOPS"],
                      "gitlab_group": env["GL_GROUP_ZFORKS"],
                      "gitlab_subgroup": env["GL_GROUP_SECOPS"],
                  },
                  {
                      "github_org": env["GH_ORG_WIKI"],
                      "gitlab_group": env["GL_GROUP_ZFORKS"],
                      "gitlab_subgroup": env["GL_GROUP_WIKI"],
                  },
                  {
                      "github_org": env["GH_ORG_DIVERGE"],
                      "gitlab_group": env["GL_GROUP_ZDIVERGE"],
                      "gitlab_subgroup": env["GL_GROUP_GENERAL"],
                  },
              ]
          }
          print(f"matrix={json.dumps(matrix)}")
          PY


  mirror:
    needs: matrix
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix.outputs.matrix) }}
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      gitlab_created: ${{ steps.gitlab-mirror.outputs.gitlab_created }}
    concurrency:
      group: gitlab-mirror-${{ matrix.github_org }}
      cancel-in-progress: false
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Load BWS config
        id: bws
        shell: bash
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_PROJECT_ID }}
        run: |
          bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
            env GITHUB_OUTPUT="${GITHUB_OUTPUT}" \
            /bin/sh .github/scripts/bws_export_output.sh \
              GH_ORG_SHARED_APP_ID \
              GH_BRANCH_PREFIX \
              GH_BRANCH_PRODUCT \
              GH_BRANCH_STAGING \
              GH_BRANCH_FEATURE \
              GH_BRANCH_RELEASE \
              GL_TOKEN_MCZFORKS \
              GH_ORG_TBOX \
              GH_ORG_SECOPS \
              GH_ORG_WIKI \
              GH_ORG_DIVERGE \
              GL_GROUP_ZFORKS \
              GL_GROUP_TBOX \
              GL_GROUP_SECOPS \
              GL_GROUP_WIKI \
              GL_GROUP_ZDIVERGE \
              GL_GROUP_GENERAL

      - name: Write app key
        shell: bash
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_PROJECT_ID }}
        run: |
          bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
            /bin/sh .github/scripts/bws_export_secret_file.sh \
              GH_ORG_SHARED_PEM \
              "${RUNNER_TEMP}/gh-app-key.pem"

      - name: Read app key
        id: app-key
        shell: bash
        run: |
          pem="$(cat "${RUNNER_TEMP}/gh-app-key.pem")"
          printf '%s\n' "$pem" | while IFS= read -r line; do
            if [ -n "$line" ]; then
              printf '::add-mask::%s\n' "$line"
            fi
          done
          {
            echo "private_key<<EOF"
            printf '%s\n' "$pem"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Mint GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ steps.bws.outputs.GH_ORG_SHARED_APP_ID }}
          private-key: ${{ steps.app-key.outputs.private_key }}
          owner: ${{ matrix.github_org }}
          repositories: ${{ inputs.repo }}

      - name: Run GitLab mirror
        id: gitlab-mirror
        env:
          GITHUB_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          INPUT_REPO: ${{ inputs.repo }}
          GH_ORG_SHARED_PEM_FILE: ${{ runner.temp }}/gh-app-key.pem
          GH_ORG_SHARED_APP_ID: ${{ steps.bws.outputs.GH_ORG_SHARED_APP_ID }}
          GH_BRANCH_PREFIX: ${{ steps.bws.outputs.GH_BRANCH_PREFIX }}
          GH_BRANCH_PRODUCT: ${{ steps.bws.outputs.GH_BRANCH_PRODUCT }}
          GH_BRANCH_STAGING: ${{ steps.bws.outputs.GH_BRANCH_STAGING }}
          GH_BRANCH_FEATURE: ${{ steps.bws.outputs.GH_BRANCH_FEATURE }}
          GH_BRANCH_RELEASE: ${{ steps.bws.outputs.GH_BRANCH_RELEASE }}
          GL_TOKEN_MCZFORKS: ${{ steps.bws.outputs.GL_TOKEN_MCZFORKS }}
          GH_ORG_TBOX: ${{ steps.bws.outputs.GH_ORG_TBOX }}
          GH_ORG_SECOPS: ${{ steps.bws.outputs.GH_ORG_SECOPS }}
          GH_ORG_WIKI: ${{ steps.bws.outputs.GH_ORG_WIKI }}
          GH_ORG_DIVERGE: ${{ steps.bws.outputs.GH_ORG_DIVERGE }}
          GL_GROUP_ZFORKS: ${{ steps.bws.outputs.GL_GROUP_ZFORKS }}
          GL_GROUP_TBOX: ${{ steps.bws.outputs.GL_GROUP_TBOX }}
          GL_GROUP_SECOPS: ${{ steps.bws.outputs.GL_GROUP_SECOPS }}
          GL_GROUP_WIKI: ${{ steps.bws.outputs.GL_GROUP_WIKI }}
          GL_GROUP_ZDIVERGE: ${{ steps.bws.outputs.GL_GROUP_ZDIVERGE }}
          GL_GROUP_GENERAL: ${{ steps.bws.outputs.GL_GROUP_GENERAL }}
        run: |
          python3 .github/scripts/gitlab_mirror.py

      - name: Apply protections
        if: steps.gitlab-mirror.outputs.gitlab_created == 'true'
        env:
          GITHUB_APP_TOKEN: ${{ steps.app-token.outputs.token }}
          INPUT_REPO: ${{ inputs.repo }}
          GH_ORG_SHARED_APP_ID: ${{ steps.bws.outputs.GH_ORG_SHARED_APP_ID }}
          GH_BRANCH_PREFIX: ${{ steps.bws.outputs.GH_BRANCH_PREFIX }}
          GH_BRANCH_STAGING: ${{ steps.bws.outputs.GH_BRANCH_STAGING }}
          GH_BRANCH_RELEASE: ${{ steps.bws.outputs.GH_BRANCH_RELEASE }}
          GL_TOKEN_MCZFORKS: ${{ steps.bws.outputs.GL_TOKEN_MCZFORKS }}
          GH_ORG_TBOX: ${{ steps.bws.outputs.GH_ORG_TBOX }}
          GH_ORG_SECOPS: ${{ steps.bws.outputs.GH_ORG_SECOPS }}
          GH_ORG_WIKI: ${{ steps.bws.outputs.GH_ORG_WIKI }}
          GH_ORG_DIVERGE: ${{ steps.bws.outputs.GH_ORG_DIVERGE }}
          GL_GROUP_ZFORKS: ${{ steps.bws.outputs.GL_GROUP_ZFORKS }}
          GL_GROUP_TBOX: ${{ steps.bws.outputs.GL_GROUP_TBOX }}
          GL_GROUP_SECOPS: ${{ steps.bws.outputs.GL_GROUP_SECOPS }}
          GL_GROUP_WIKI: ${{ steps.bws.outputs.GL_GROUP_WIKI }}
          GL_GROUP_ZDIVERGE: ${{ steps.bws.outputs.GL_GROUP_ZDIVERGE }}
          GL_GROUP_GENERAL: ${{ steps.bws.outputs.GL_GROUP_GENERAL }}
        run: |
          python3 .github/scripts/gitlab_branch_protection.py

      - name: Post cleanup
        if: always()
        shell: bash
        run: |
          rm -f "${RUNNER_TEMP}/gh-app-key.pem"
          for key in GH_ORG_SHARED_PEM_FILE GITHUB_APP_TOKEN; do
            printf '%s<<EOF\nEOF\n' "$key" >> "$GITHUB_ENV"
          done
