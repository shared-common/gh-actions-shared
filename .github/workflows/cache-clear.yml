name: Clear Repo Caches

on:
  workflow_dispatch:
    inputs:
      github_org:
        description: "Optional org name to target (defaults to all managed orgs)"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: cache-clear-${{ github.workflow }}-${{ github.ref }}-${{ inputs.github_org || 'all' }}
  cancel-in-progress: true

jobs:
  matrix:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    outputs:
      matrix: ${{ steps.select-matrix.outputs.matrix }}
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install bws CLI
        uses: ./.github/actions/install-bws
        with:
          version: "1.0.0"
          sha256: "9077fb7b336a62abc8194728fea8753afad8b0baa3a18723fc05fc02fdb53568"

      - name: Load BWS config and build matrix
        id: build-matrix
        shell: bash
        env:
          BWS_ACCESS_TOKEN: ${{ secrets.BWS_ACCESS_TOKEN }}
          BWS_PROJECT_ID: ${{ vars.BWS_PROJECT_ID }}
        run: |
          set -euo pipefail
          bws run --project-id "${BWS_PROJECT_ID:?}" --no-inherit-env -- \
            env PATH="${PATH}" GITHUB_OUTPUT="${GITHUB_OUTPUT}" \
            /bin/sh .github/scripts/build_org_matrix.sh

      - name: Select matrix
        id: select-matrix
        shell: bash
        env:
          INPUT_ORG: ${{ inputs.github_org }}
          MATRIX_JSON: ${{ steps.build-matrix.outputs.matrix }}
        run: |
          set -euo pipefail
          if [ -z "${INPUT_ORG}" ]; then
            printf 'matrix=%s\n' "${MATRIX_JSON}" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          python3 -c 'import json,os,sys; matrix_json=os.environ.get("MATRIX_JSON",""); \
            data=json.loads(matrix_json); org=os.environ.get("INPUT_ORG","").strip(); \
            include=data.get("include") if isinstance(data,dict) else None; \
            (include is not None and isinstance(include,list)) or sys.exit("Matrix include list is missing"); \
            org or sys.exit("INPUT_ORG is empty"); \
            filtered=[item for item in include if isinstance(item,dict) and item.get("github_org")==org]; \
            filtered or sys.exit(f"Unknown org: {org}"); \
            print(f"matrix={json.dumps({'\''include'\'': filtered})}")' >> "$GITHUB_OUTPUT"

  clear:
    needs: matrix
    name: Clear caches (${{ matrix.github_org }})
    strategy:
      fail-fast: false
      matrix: ${{ fromJSON(needs.matrix.outputs.matrix) }}
      max-parallel: 1
    runs-on: ubuntu-24.04
    permissions:
      contents: read
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare empty cache files
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${GITHUB_WORKSPACE}/.cache"
          printf '[]' > "${GITHUB_WORKSPACE}/.cache/repo-discovery.json"
          printf '{}' > "${GITHUB_WORKSPACE}/.cache/repo-metadata.json"

      - name: Save empty repo caches
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ github.workspace }}/.cache/repo-discovery.json
            ${{ github.workspace }}/.cache/repo-metadata.json
          key: >-
            orchestrator-discovery-${{ github.repository }}-${{ matrix.github_org }}-${{ matrix.github_org }}-${{ github.run_id }}
